#! /bin/python3
# https://github.com/manesec/tools4mane
# write by @manesec.

import fileinput
import re
import subprocess
import json
import argparse


"""
 ▄▀▀▄ ▄▀▄  ▄▀▀█▄   ▄▀▀▄ ▀▄  ▄▀▀█▄▄▄▄  ▄▀▀▀▀▄  ▄▀▀█▄▄▄▄  ▄▀▄▄▄▄  
█  █ ▀  █ ▐ ▄▀ ▀▄ █  █ █ █ ▐  ▄▀   ▐ █ █   ▐ ▐  ▄▀   ▐ █ █    ▌ 
▐  █    █   █▄▄▄█ ▐  █  ▀█   █▄▄▄▄▄     ▀▄     █▄▄▄▄▄  ▐ █      
  █    █   ▄▀   █   █   █    █    ▌  ▀▄   █    █    ▌    █      
▄▀   ▄▀   █   ▄▀  ▄▀   █    ▄▀▄▄▄▄    █▀▀▀    ▄▀▄▄▄▄    ▄▀▄▄▄▄▀ 
█    █    ▐   ▐   █    ▐    █    ▐    ▐       █    ▐   █     ▐  
▐    ▐            ▐         ▐                 ▐        ▐        

Using WES result to query exploit DB Title - Tools4me by @manesec
                    Version: 20220607
            https://github.com/manesec/tools4mane
---------------------------------------------------------------
Example:
    wes systeminfo.txt -e -i "Elevation of Privilege" | WesQueryExploitDB.py
    
"""
TmpList = {}

def QueryExploitDB(number):
    print("[%s] " % number,end='')
    output = subprocess.getoutput("searchsploit -j %s" % number)
    jsonload = json.loads(output)
    if (len(jsonload["RESULTS_EXPLOIT"]) == 0):
        print("No found.")
        return
    else:
        for result in jsonload["RESULTS_EXPLOIT"]:
            if result["EDB-ID"] == number:
                data = (result["Title"]) + "\n"
                data += "    Date: " + result["Date"] + "\n"
                data += "    Platform: " + result["Platform"]+ "\n"
                data += "    Type: " + result["Type"]+ "\n"
                data += "    Author: " + result["Author"]+ "\n"
                print(data)
                if number not in TmpList.keys():
                    TmpList[number] = ("[%s] " % number) + data
                return

for line in fileinput.input():
    print(line,end="")

    if (line[:9] == "Exploit: "):
        expurl = line[9:].split(",")
        for x in expurl:
            if (x.find("www.exploit-db.com/exploits")!= -1):
                reg = (re.search("exploits/(.*)(/|$)", x.strip()).groups())[0]
                reg = reg.replace("/", "")
                QueryExploitDB(reg)
            
    if (line[:10] == "Exploits: "):
        expurl = line[10:].split(",")
        for x in expurl:
            if (x.find("www.exploit-db.com/exploits")!= -1):
                reg = (re.search("exploits/(.*)(/|$)", x.strip()).groups())[0]
                reg = reg.replace("/", "")
                QueryExploitDB(reg)

print("="*60)
print("[+] For WesQueryExploitDB Summary ")
for key in TmpList.keys():
    print(TmpList[key])